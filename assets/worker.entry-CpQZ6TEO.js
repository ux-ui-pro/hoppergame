(function(){"use strict";const I={hitboxW:20,hitboxH:60,visualHeight:80,offsetX:5},H={blight:{hitboxW:30,hitboxH:40,visualHeight:80,offsetX:4,offsetY:0},skeleton:{hitboxW:20,hitboxH:60,visualHeight:80,offsetX:-7,offsetY:0},heart:{hitboxW:16,hitboxH:16,visualHeight:80,offsetX:0,offsetY:28},coin:{hitboxW:24,hitboxH:24,visualHeight:80,offsetX:0,offsetY:30}},j=160;function O(e,t){let o=e;if(!o.startsWith("data:")){const n=new URL(o);n.searchParams.set("v",t),o=n.toString()}return o}const B=new URL("./runner-sprite-sheet-DtfMcDYK.webp",self.location.href),G=new URL("./runner-sprite-sheet-BYwRWmd0.json",self.location.href),i={ctx:null,canvas:null,cssW:0,cssH:0,scale:1,transparentBg:!1,ready:!1,expectResize:!1,readyTimer:null,score:0,collisionsCount:0,uiDirty:!0,uiElapsedMs:0,uiIntervalMs:120,player:{x:0,y:550-I.hitboxH,width:I.hitboxW,height:I.hitboxH,vy:0,isJumping:!1},entities:[],spawnTimerSec:0,sinceLastOnigiriCount:0,nextSpawnSec:1+Math.random()*(1.9-1),pendingJump:!1,coinSpawnTimerSec:0,coinNextSpawnSec:0,skyColor:"#e0f7fa",debugDrawHitboxes:!1,playerSpriteUrl:O(B.toString(),"3"),playerAtlasUrl:O(G.toString(),"3"),playerSprite:null,playerAtlas:null,playerSpriteLoading:!1,playerRunFrames:[],playerJumpFrames:[],playerHitFrames:[],playerRewardFrames:[],blightFrames:[],heartFrames:[],coinFrameName:null,coinFrames:[],blightAnimElapsedMs:0,blightAnimFrameIndex:0,skeletonFrames:[],heartAnimElapsedMs:0,heartAnimFrameIndex:0,coinAnimElapsedMs:0,coinAnimFrameIndex:0,skeletonAnimElapsedMs:0,skeletonAnimFrameIndex:0,playerAnimFps:12,playerAnimFrameMs:1e3/12,playerAnimElapsedMs:0,playerAnimFrameIndex:0,playerRunStartIndexAtJump:0,playerRunPhaseMsDuringJump:0,playerJumpElapsedMs:0,playerJumpTotalMs:2*Math.abs(720)/Math.abs(2160)*1e3,playerHitPlaying:!1,playerHitElapsedMs:0,playerHitFrameIndex:0,playerRewardPlaying:!1,playerRewardElapsedMs:0,playerRewardFrameIndex:0,prevPlayerY:550-I.hitboxH};function J(e,t,o,n){e.cssW=Math.max(1,Math.floor(t)),e.cssH=Math.max(1,Math.floor(o));const c=Math.min(Math.max(n||1,1),2),h=1400/e.cssW,a=900/e.cssH;let y="dpr",l=c;h<l&&(l=h,y="w"),a<l&&(l=a,y="h"),e.scale=Math.max(1/8,l);let s=0,p=0;y==="h"?(p=Math.max(1,Math.floor(e.cssH*e.scale)),s=Math.max(1,Math.round(p*(e.cssW/e.cssH)))):y==="w"?(s=Math.max(1,Math.floor(e.cssW*e.scale)),p=Math.max(1,Math.round(s*(e.cssH/e.cssW)))):(s=Math.max(1,Math.round(e.cssW*e.scale)),p=Math.max(1,Math.round(e.cssH*e.scale))),!(!e.canvas||!e.ctx)&&(e.canvas.width!==s&&(e.canvas.width=s),e.canvas.height!==p&&(e.canvas.height=p),e.player.x=e.cssW*.14)}function U(e,t){if(e.ctx){if(e.prevPlayerY=e.player.y,!e.player.isJumping&&e.pendingJump){e.player.isJumping=!0,e.player.vy=-720,e.pendingJump=!1;try{postMessage({type:"sfx",s:"jump"})}catch{}e.playerRunStartIndexAtJump=e.playerAnimFrameIndex,e.playerRunPhaseMsDuringJump=0,e.playerJumpElapsedMs=0}if(e.player.isJumping&&(e.player.vy+=2160*t,e.player.y+=e.player.vy*t,e.playerRunPhaseMsDuringJump+=t*1e3,e.playerJumpElapsedMs=Math.min(e.playerJumpTotalMs,e.playerJumpElapsedMs+t*1e3),e.player.y>=550-e.player.height&&(e.player.y=550-e.player.height,e.player.vy=0,e.player.isJumping=!1,e.playerJumpElapsedMs=e.playerJumpTotalMs,e.playerRunFrames.length>0&&(e.playerAnimFrameIndex=0,e.playerAnimElapsedMs=0),e.playerRunPhaseMsDuringJump=0)),e.playerSprite&&e.playerAtlas){if(e.playerRewardPlaying&&e.playerRewardFrames.length>0)for(e.playerRewardElapsedMs+=t*1e3;e.playerRewardElapsedMs>=e.playerAnimFrameMs;)if(e.playerRewardElapsedMs-=e.playerAnimFrameMs,e.playerRewardFrameIndex+1<e.playerRewardFrames.length)e.playerRewardFrameIndex+=1;else{e.playerRewardPlaying=!1,e.playerRewardFrameIndex=e.playerRewardFrames.length-1;break}else if(e.playerHitPlaying&&e.playerHitFrames.length>0)for(e.playerHitElapsedMs+=t*1e3;e.playerHitElapsedMs>=e.playerAnimFrameMs;)if(e.playerHitElapsedMs-=e.playerAnimFrameMs,e.playerHitFrameIndex+1<e.playerHitFrames.length)e.playerHitFrameIndex+=1;else{e.playerHitPlaying=!1,e.playerHitFrameIndex=e.playerHitFrames.length-1;break}else if(e.playerRunFrames.length>0)if(e.player.isJumping)e.playerAnimFrameIndex=0,e.playerAnimElapsedMs=0;else for(e.playerAnimElapsedMs+=t*1e3;e.playerAnimElapsedMs>=e.playerAnimFrameMs;)e.playerAnimElapsedMs-=e.playerAnimFrameMs,e.playerAnimFrameIndex=(e.playerAnimFrameIndex+1)%e.playerRunFrames.length}if(e.coinFrames.length>0)for(e.coinAnimElapsedMs+=t*1e3;e.coinAnimElapsedMs>=e.playerAnimFrameMs;)e.coinAnimElapsedMs-=e.playerAnimFrameMs,e.coinAnimFrameIndex=(e.coinAnimFrameIndex+1)%e.coinFrames.length;if(e.heartFrames.length>0)for(e.heartAnimElapsedMs+=t*1e3;e.heartAnimElapsedMs>=e.playerAnimFrameMs;)e.heartAnimElapsedMs-=e.playerAnimFrameMs,e.heartAnimFrameIndex=(e.heartAnimFrameIndex+1)%e.heartFrames.length;if(e.skeletonFrames.length>0)for(e.skeletonAnimElapsedMs+=t*1e3;e.skeletonAnimElapsedMs>=e.playerAnimFrameMs;)e.skeletonAnimElapsedMs-=e.playerAnimFrameMs,e.skeletonAnimFrameIndex=(e.skeletonAnimFrameIndex+1)%e.skeletonFrames.length;if(e.blightFrames&&e.blightFrames.length>0)for(e.blightAnimElapsedMs+=t*1e3;e.blightAnimElapsedMs>=e.playerAnimFrameMs;)e.blightAnimElapsedMs-=e.playerAnimFrameMs,e.blightAnimFrameIndex=(e.blightAnimFrameIndex+1)%e.blightFrames.length;if(e.spawnTimerSec+=t,e.spawnTimerSec>=e.nextSpawnSec){const o=Math.random();let n;if(e.sinceLastOnigiriCount<1?n="negative":e.sinceLastOnigiriCount>=6?n="collectible":n=o<.25?"collectible":"negative",n==="negative"){if(Math.random()<.35){const h=H.skeleton;e.entities.push({x:e.cssW,y:550-h.hitboxH,width:h.hitboxW,height:h.hitboxH,kind:"skeleton"})}else{const h=H.blight;e.entities.push({x:e.cssW,y:550-h.hitboxH,width:h.hitboxW,height:h.hitboxH,kind:"blight"})}e.sinceLastOnigiriCount+=1}else{const c=H.heart;e.entities.push({x:e.cssW,y:550-c.hitboxH,width:c.hitboxW,height:c.hitboxH,kind:"heart"}),e.sinceLastOnigiriCount=0}e.spawnTimerSec=0,e.nextSpawnSec=1+Math.random()*(1.9-1)}if(e.coinSpawnTimerSec+=t,e.coinNextSpawnSec<=0&&(e.coinNextSpawnSec=3.2+Math.random()*(6.4-3.2)),e.coinSpawnTimerSec>=e.coinNextSpawnSec){const o=H.coin,n=o.hitboxH,c=720*720/(2*Math.abs(2160)),h=Math.max(0,550-c),a=Math.max(0,h-n);e.entities.push({x:e.cssW,y:a,width:o.hitboxW,height:n,kind:"coin"}),e.coinSpawnTimerSec=0,e.coinNextSpawnSec=3.2+Math.random()*(6.4-3.2)}for(let o=e.entities.length-1;o>=0;o--){const n=e.entities[o];if(n.x-=240*t,n.x+n.width<0){e.entities.splice(o,1),(n.kind==="blight"||n.kind==="skeleton")&&e.score++,e.uiDirty=!0;continue}if(n.x<e.player.x+e.player.width&&n.x+n.width>e.player.x&&n.y<e.player.y+e.player.height&&n.y+n.height>e.player.y)if(n.kind==="heart"||n.kind==="coin"){if(e.entities.splice(o,1),e.score+=3,e.uiDirty=!0,n.kind==="coin")try{postMessage({type:"sfx",s:"coin"})}catch{}else if(n.kind==="heart")try{postMessage({type:"sfx",s:"heart"})}catch{}e.playerRewardFrames.length>0&&(e.playerRewardPlaying=!0,e.playerRewardElapsedMs=0,e.playerRewardFrameIndex=0)}else{if(e.entities.splice(o,1),e.collisionsCount++,e.uiDirty=!0,n.kind==="blight")try{postMessage({type:"sfx",s:"blight"})}catch{}else if(n.kind==="skeleton")try{postMessage({type:"sfx",s:"skeleton"})}catch{}e.playerHitFrames.length>0&&(e.playerHitPlaying=!0,e.playerHitElapsedMs=0,e.playerHitFrameIndex=0)}}}}async function z(e){var t,o;if(e.ctx&&!(e.playerSprite||e.playerAtlas||e.playerSpriteLoading)&&!(!e.playerSpriteUrl||!e.playerAtlasUrl)){e.playerSpriteLoading=!0;try{const[n,c]=await Promise.all([fetch(e.playerSpriteUrl),fetch(e.playerAtlasUrl)]);if(!n.ok)throw new Error("Failed to fetch player sprite");if(!c.ok)throw new Error("Failed to fetch player atlas");const[h,a]=[await n.blob(),await c.json()],y=await createImageBitmap(h),l=(r,P)=>{var V,Y;const L=((V=r[1].frame)==null?void 0:V.x)??0,D=((Y=P[1].frame)==null?void 0:Y.x)??0;if(L!==D)return L-D;const Z=parseInt(r[0].split("_")[1]||"0",10),$=parseInt(P[0].split("_")[1]||"0",10);return Z-$},s=a.frames||{},p=Object.entries(s).filter(([r])=>r.startsWith("run_")).sort(l),d=Object.entries(s).filter(([r])=>r.startsWith("jump_")).sort(l),m=Object.entries(s).filter(([r])=>r.startsWith("hit_")).sort(l),g=Object.entries(s).filter(([r])=>r.startsWith("blight_")).sort(l),x=Object.entries(s).filter(([r])=>r.startsWith("heart_")).sort(l),M=Object.entries(s).filter(([r])=>r.startsWith("coin_")).sort(l),_=Object.entries(s).filter(([r])=>r.startsWith("skeleton_")).sort(l),f=r=>(r||[]).filter(P=>!!s[P]),u=a.animations||{};let A=f(u.run),w=f(u.jump),E=f(u.hit),S=f(u.reward),R=f(u.blight),N=f(u.heart),k=(t=f(u.coin))==null?void 0:t[0],b=f(u.coin),F=f(u.skeleton);(!A||A.length===0)&&(A=p.map(([r])=>r)),(!w||w.length===0)&&(w=d.map(([r])=>r)),(!E||E.length===0)&&(E=m.map(([r])=>r)),(!S||S.length===0)&&(S=Object.keys(s).filter(r=>r.startsWith("reward_")).sort().map(r=>r)),(!R||R.length===0)&&(R=g.map(([r])=>r)),(!N||N.length===0)&&(N=x.map(([r])=>r)),k||(k=(o=M[0])==null?void 0:o[0]),(!b||b.length===0)&&(b=M.map(([r])=>r)),(!F||F.length===0)&&(F=_.map(([r])=>r)),e.playerRunFrames=A,e.playerJumpFrames=w,e.playerHitFrames=E,e.playerRewardFrames=S,e.blightFrames=R||[],e.heartFrames=N||[],e.coinFrameName=k??null,e.coinFrames=b||[],e.skeletonFrames=F||[],e.playerSprite=y,e.playerAtlas=a}finally{e.playerSpriteLoading=!1}}}function K(e,t=1,o=1/60){if(!e.ctx||!e.canvas)return;e.transparentBg?e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height):(e.ctx.fillStyle=e.skyColor,e.ctx.fillRect(0,0,e.canvas.width,e.canvas.height));const n=e.cssH-j,c=Math.round((n-550)*e.scale),h=e.prevPlayerY+(e.player.y-e.prevPlayerY)*t;if(z(e),e.playerSprite&&e.playerAtlas){let a=null;if(e.playerRewardPlaying&&e.playerRewardFrames.length>0)a=e.playerRewardFrames[Math.max(0,Math.min(e.playerRewardFrames.length-1,e.playerRewardFrameIndex))]||null;else if(e.playerHitPlaying&&e.playerHitFrames.length>0)a=e.playerHitFrames[Math.max(0,Math.min(e.playerHitFrames.length-1,e.playerHitFrameIndex))]||null;else if(e.player.isJumping&&e.playerJumpFrames.length>0){const p=e.playerJumpTotalMs||1,d=Math.max(0,Math.min(1,e.playerJumpElapsedMs/p)),m=.1;if(d<m&&e.playerRunFrames.length>0)a=e.playerRunFrames[Math.max(0,Math.min(e.playerRunFrames.length-1,e.playerRunStartIndexAtJump))];else{const g=Math.max(0,Math.min(1,(d-m)/(1-m))),x=e.playerJumpFrames.length,M=Math.max(0,Math.min(x-1,Math.floor(g*(x-1)+1e-6)));a=e.playerJumpFrames[M]}}else e.playerRunFrames.length>0&&(a=e.playerRunFrames[Math.max(0,Math.min(e.playerRunFrames.length-1,e.playerAnimFrameIndex))]);const y=a?e.playerAtlas.frames[a]:void 0,l=y==null?void 0:y.frame,s=(y==null?void 0:y.pivot)||{x:.5,y:1};if(l){const p=I.visualHeight,d=l.w/l.h*p,m=e.player.x-s.x*d+I.offsetX,x=h+e.player.height+0-p*s.y,M=Math.round(m*e.scale),_=Math.round(x*e.scale+c),f=Math.max(1,Math.round(d*e.scale)),u=Math.max(1,Math.round(p*e.scale)),A=e.ctx.imageSmoothingEnabled;e.ctx.imageSmoothingEnabled=!1,e.ctx.drawImage(e.playerSprite,l.x,l.y,l.w,l.h,M,_,f,u),e.ctx.imageSmoothingEnabled=A}}else e.ctx.fillStyle="#000",e.ctx.fillRect(Math.round(e.player.x*e.scale),Math.round(h*e.scale+c),Math.round(e.player.width*e.scale),Math.round(e.player.height*e.scale));if(e.debugDrawHitboxes){const a=Math.round(e.player.x*e.scale),y=Math.round(h*e.scale+c),l=Math.round(e.player.width*e.scale),s=Math.round(e.player.height*e.scale);e.ctx.save(),e.ctx.globalAlpha=.3,e.ctx.fillStyle="#ff00ff",e.ctx.fillRect(a,y,l,s),e.ctx.globalAlpha=1,e.ctx.lineWidth=Math.max(1,Math.round(e.scale)),e.ctx.strokeStyle="#ff00ff",e.ctx.strokeRect(a,y,l,s),e.ctx.restore()}for(const a of e.entities){const l=a.x+240*o*(1-t),s=a.y;if(e.playerSprite&&e.playerAtlas&&(a.kind==="blight"||a.kind==="skeleton"||a.kind==="heart"||a.kind==="coin")){const p=a.kind==="blight"?e.blightFrames.length>0?e.blightFrames[Math.max(0,Math.min(e.blightFrames.length-1,e.blightAnimFrameIndex))]:null:a.kind==="skeleton"?e.skeletonFrames.length>0?e.skeletonFrames[Math.max(0,Math.min(e.skeletonFrames.length-1,e.skeletonAnimFrameIndex))]:null:a.kind==="heart"?e.heartFrames.length>0?e.heartFrames[Math.max(0,Math.min(e.heartFrames.length-1,e.heartAnimFrameIndex))]:null:e.coinFrames.length>0?e.coinFrames[Math.max(0,Math.min(e.coinFrames.length-1,e.coinAnimFrameIndex))]:e.coinFrameName,d=p?e.playerAtlas.frames[p]:void 0,m=d==null?void 0:d.frame,g=(d==null?void 0:d.pivot)||{x:.5,y:1};if(m){const x=H[a.kind],M=x.visualHeight,_=m.w/m.h*M,f=l-g.x*_+a.width*.5+(x.offsetX||0),A=s+a.height+(x.offsetY||0)-M*g.y,w=Math.round(f*e.scale),E=Math.round(A*e.scale+c),S=Math.max(1,Math.round(_*e.scale)),R=Math.max(1,Math.round(M*e.scale)),N=e.ctx.imageSmoothingEnabled;if(e.ctx.imageSmoothingEnabled=!1,e.ctx.drawImage(e.playerSprite,m.x,m.y,m.w,m.h,w,E,S,R),e.ctx.imageSmoothingEnabled=N,e.debugDrawHitboxes){const k=Math.round(l*e.scale),b=Math.round(s*e.scale+c),F=Math.round(a.width*e.scale),r=Math.round(a.height*e.scale);e.ctx.save(),e.ctx.globalAlpha=.3,e.ctx.fillStyle="#ff00ff",e.ctx.fillRect(k,b,F,r),e.ctx.globalAlpha=1,e.ctx.lineWidth=Math.max(1,Math.round(e.scale)),e.ctx.strokeStyle="#ff00ff",e.ctx.strokeRect(k,b,F,r),e.ctx.restore()}continue}}if(e.ctx.fillStyle=a.kind==="heart"?"#0a0":a.kind==="coin"?"#fc0":"red",e.ctx.fillRect(Math.round(l*e.scale),Math.round(s*e.scale+c),Math.round(a.width*e.scale),Math.round(a.height*e.scale)),e.debugDrawHitboxes){const p=Math.round(l*e.scale),d=Math.round(s*e.scale+c),m=Math.round(a.width*e.scale),g=Math.round(a.height*e.scale);e.ctx.save(),e.ctx.globalAlpha=.3,e.ctx.fillStyle="#ff00ff",e.ctx.fillRect(p,d,m,g),e.ctx.globalAlpha=1,e.ctx.lineWidth=Math.max(1,Math.round(e.scale)),e.ctx.strokeStyle="#ff00ff",e.ctx.strokeRect(p,d,m,g),e.ctx.restore()}}}function T(){i.ready||(i.ready=!0,postMessage({type:"ready"}))}let W=0,C=0;const v=1e3/60,X=100,q=5;function Q(e){if(!i.ready)return;W||(W=e);let t=e-W;W=e,t<0&&(t=0),t>X&&(t=X),C+=t;let o=0;for(;C>=v&&o<q;)U(i,v/1e3),C-=v,o++;i.uiElapsedMs+=t,i.uiDirty&&i.uiElapsedMs>=i.uiIntervalMs&&(postMessage({type:"ui",score:i.score,collisionsCount:i.collisionsCount}),i.uiDirty=!1,i.uiElapsedMs=0);const n=Math.max(0,Math.min(1,C/v));K(i,n,v/1e3)}onmessage=e=>{const t=e.data||{};switch(t.type){case"init":{i.canvas=t.canvas,i.skyColor=typeof t.skyColor=="string"?t.skyColor:i.skyColor,i.expectResize=!!t.expectResize,i.debugDrawHitboxes=!!t.debugHitboxes;const o=!!t.alpha;if(i.ctx=i.canvas.getContext("2d",{alpha:o}),!i.ctx)return;i.ctx.imageSmoothingEnabled=!1,i.transparentBg=!!t.transparentBg,J(i,t.cssW,t.cssH,t.dpr),i.expectResize?(i.readyTimer&&clearTimeout(i.readyTimer),i.readyTimer=setTimeout(()=>{T()},200)):T();break}case"resize":{J(i,t.cssW,t.cssH,t.dpr),i.expectResize&&(i.expectResize=!1,i.readyTimer&&(clearTimeout(i.readyTimer),i.readyTimer=null),T());break}case"frame":{Q(typeof t.now=="number"?t.now:performance.now());break}case"vis":{W=0,C=0;break}case"input":{(t.tap||t.space)&&(i.player.isJumping||(i.pendingJump=!0));break}}}})();
//# sourceMappingURL=worker.entry-CpQZ6TEO.js.map
